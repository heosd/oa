<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget simple</title>
    <style>
        .ss-table {
            font-family: arial, sans-serif;
            border-collapse: collapse;

            td,
            th {
                border: 1px solid #aaa;
                padding: 5px;
            }

            tr:nth-child(even) {
                background-color: #eee;
            }
        }
    </style>
</head>

<body>

    <section id="section-input-url">
        <input id="inputURL" type="text" placeholder="url to csv">
        <button onclick="onClickFetch()">Fetch</button>
    </section>

    <section id="section-select-cols">
        <label for="select-date">Select Date column</label>
        <select id="select-date"></select>
        <br>
        <label for="select-cost">Select Cost column</label>
        <select id="select-cost"></select>
        <br>
        <label for="select-user">Select User column</label>
        <select id="select-user"></select>
        <br>
        <label for="select-product">Select Product column</label>
        <select id="select-product"></select>
        <br>
        <input id="input-product-deposit" type="text" value="deposit">

        <br>

        <button onclick="app.execCSVtoDataSource()">GO!</button>
    </section>

    <section id="section-plot"></section>
    <section id="section-table"></section>

    <section id="section-templates" style="display: none;">
        <template id="template-table">
            <table class="ss-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Total Income</th>
                        <th>Total Outcome</th>
                        <th>Spent %</th>
                        <th>Rest</th>
                        <th>Rest %</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </template>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>

    <script>
        const testProcedure = true;

        async function onClickFetch() {
            const url = document.getElementById('inputURL').value.trim();
            if (5 > url.length) {
                alert("Invalid url");
                return;
            }

            let finalurl = url;
            // google spreadsheet adjusting
            if (-1 < url.indexOf('http')) {
                const matchEdit = url.match(/https:\/\/docs.google.com\/spreadsheets\/d\/([^/]+)\/edit/);
                if (matchEdit) {
                    finalurl = `https://docs.google.com/spreadsheets/d/${matchEdit[1]}/pub?gid=0&single=true&output=csv`;
                }
            }

            try {
                console.log('fetch : ' + finalurl);
                const res = await fetch(finalurl);
                const text = await res.text();
                app.execCSV(text);

                // const csv = processCSV(text);
                // postProcessCSV(csv);
            } catch (e) {
                alert('Failed to get data from url');
                console.error(e);
            }
        }

        class BudgetApp {
            ds = new DataSource();

            execCSV(text) {
                const csv = pp.csv(text);
                this.ds.raw = csv;
                this.ds.rawcols = csv.columns;

                view.refreshSelectCols(this.ds.rawcols);
            }

            execCSVtoDataSource() {
                const list = this.ds.raw;
                const cols = view.getColumnSelect();

                // dataSource
                const ds = pp.listToDataSource(list, cols);
                this.ds.ds = ds;

                this.batchDataSource();
                this.refreshTable();
                this.refreshPlot();
            }

            batchDataSource() {
                const ds = this.ds.ds;
                const mapYear = pp.groupYear(ds);

                this.ds.mapYear = mapYear;

                const mapYearSS = new Map();
                mapYear.forEach((list, year) => {
                    list.ss = pp.ssUser(list);
                });
            }

            refreshTable() {
                const years = this.ds.getYearKeys();

                years.forEach(year => {
                    const ss = this.ds.getYearSS(year);
                    const table = view.createTableOneYear(ss);
                    view.appendTableOneYear(table);
                });
            }

            refreshPlot() {
                const years = this.ds.getYearKeys();
                const cols = view.getColumnSelect();
                years.forEach(year => {
                    const list = this.ds.getYear(year);
                    const table = view.createPlotOneYear(list, cols);
                    view.appendPlotOneYear(table);
                });
            }

        }

        class pp {
            static csv(text) {
                const csv = d3.csvParse(text);
                return csv;
            }

            // to DataSource
            static listToDataSource(list, columnSelected) {
                const src = list;
                const cols = columnSelected;

                const ds = src.map(d => {
                    const obj = {
                        date: new Date(d[cols.date]),
                        cost: parseFloat(d[cols.cost]),
                        user: d[cols.user],
                        prod: d[cols.prod],
                        // income or outcome
                        io: d[cols.prod] === cols.deposit ? 'i' : 'o',
                        item: d
                    };

                    return obj;
                });

                return ds;
            }

            static groupYear(ds) {
                return d3.group(ds, d => d.date.getFullYear());
            }


            static ssDataSource(ds) {
                // const ds = window.dataSource;

                // split by year
                const mapYears = d3.rollup(ds, list => {
                    const ss = pp.ssUser(list);
                    ss.year = list[0].date.getFullYear();
                    return ss;
                }, d => d.date.getFullYear());

                return mapYears;
            }

            static ssUser(dsYearList) {
                const src = dsYearList;
                const byUsers = d3.rollups(src, (listUser) => {

                    const ioSum = d3.rollup(listUser
                        , (listInOut) => d3.sum(listInOut, d => d.cost)
                        , d => d.io);
                    const ic = ioSum.get('i') ?? 0;
                    const oc = ioSum.get('o') ?? 0;
                    const rest = ic - oc;
                    let spentpercent = (oc / ic) * 100;
                    if (isNaN(spentpercent)) {
                        spentpercent = 101;
                    }
                    const restpercent = 100 - spentpercent;

                    return {
                        totalincome: ic,
                        totaloutcome: oc,
                        user: listUser[0].user,
                        rest,
                        spentpercent,
                        restpercent,
                    }
                }, d => d.user).map(d => d[1]);

                return byUsers;
            }
        }

        class DataSource {
            // data sources
            raw = undefined;
            rawcols = undefined;
            ds = undefined;
            mapYear = undefined;

            getYear(year) {
                return this.mapYear?.get(year)
            }

            getYearSS(year) {
                return this.getYear(year)?.ss;
            }

            getYearKeys() {
                return Array.from(this.mapYear.keys());
            }
        }

        class BudgetView {
            // function createOptions
            static createOptions = (list) => {
                return list.map(d => {
                    const opt = document.createElement('option');
                    opt.textContent = d;
                    opt.value = d;
                    return opt;
                });
            }

            static createTR = (datas) => {
                const tr = document.createElement('tr');
                datas.forEach(d => {
                    const td = document.createElement('td');
                    td.textContent = d;
                    tr.appendChild(td);
                });

                return tr;
            }

            static refreshSelectCols(cols) {
                const src = cols;

                // create Options for all
                const listSelect = document.getElementById('section-select-cols').querySelectorAll('select');
                listSelect.forEach(e => view.createOptions(src).forEach(opt => e.appendChild(opt)));

                // default
                const selectDate = document.getElementById('select-date');
                const selectCost = document.getElementById('select-cost');
                const selectUser = document.getElementById('select-user');
                const selectProd = document.getElementById('select-product');

                const listDefaultDate = ['date'];
                const listDefaultCost = ['cost', 'price'];
                const listDefaultUser = ['user', 'group', 'type'];
                const listDefaultProd = ['product'];

                const foundDate = Array.from(selectDate.querySelectorAll('option')).filter(d => listDefaultDate.some(key => -1 < d.value.toLocaleLowerCase().indexOf(key)));
                const foundCost = Array.from(selectCost.querySelectorAll('option')).filter(d => listDefaultCost.some(key => -1 < d.value.toLocaleLowerCase().indexOf(key)));
                const foundUser = Array.from(selectUser.querySelectorAll('option')).filter(d => listDefaultUser.some(key => -1 < d.value.toLocaleLowerCase().indexOf(key)));
                const foundProd = Array.from(selectProd.querySelectorAll('option')).filter(d => listDefaultProd.some(key => -1 < d.value.toLocaleLowerCase().indexOf(key)));

                // set default if exists
                foundDate ? (selectDate.value = foundDate[0].value) : 0;
                foundCost ? (selectCost.value = foundCost[0].value) : 0;
                foundUser ? (selectUser.value = foundUser[0].value) : 0;
                foundProd ? (selectProd.value = foundProd[0].value) : 0;
            }

            static getColumnSelect() {
                const selectDate = document.getElementById('select-date');
                const selectCost = document.getElementById('select-cost');
                const selectUser = document.getElementById('select-user');
                const selectProd = document.getElementById('select-product');
                const inputProd = document.getElementById('input-product-deposit');

                const cols = {
                    date: selectDate.value,
                    cost: selectCost.value,
                    user: selectUser.value,
                    prod: selectProd.value,
                    deposit: inputProd.value,
                };

                return cols;
            }

            static createTableOneYear(ss) {
                // descending any value bigger
                const sssorted = ss.toSorted((a, b) =>
                    Math.max(b.totalincome, b.totaloutcome)
                    - Math.max(a.totalincome, a.totaloutcome)
                );

                const template = document.getElementById('template-table');
                const table = template.content.cloneNode(true);
                const tbody = table.querySelector('tbody');

                const orderObj = (obj) => [
                    obj.user,
                    obj.totalincome.toLocaleString(),
                    obj.totaloutcome.toLocaleString(),
                    obj.spentpercent.toFixed(1) + '%',
                    obj.rest.toLocaleString(),
                    obj.restpercent.toFixed(1) + '%',
                ];

                sssorted.forEach(d => {
                    tbody.appendChild(BudgetView.createTR(orderObj(d)));
                });

                return table;
            }

            static createPlotOneYear(dsYear, cols) {
                const src = dsYear;
                const fnLegend = d => d === 'i' ? '수입' : '지출';

                const plot = Plot.plot({
                    // fx: { padding: 0, label: null, tickRotate: 90, tickSize: 6 },
                    x: { axis: null, paddingOuter: 0.2, label: cols.user },
                    y: { grid: true, tickFormat: "s", label: cols.cost },
                    style: { fontSize: 15 },
                    color: { legend: true, scheme: "Category10", tickFormat: fnLegend },
                    marks: [
                        // Plot.frame(),
                        Plot.barY(
                            dsYear,
                            Plot.groupX(
                                { y2: "sum" },
                                {
                                    x: "io",
                                    fx: "user",
                                    y2: "cost",
                                    fill: "io",
                                    sort: { fx: "y", order: "descending" },
                                }
                            )
                        ),
                        Plot.ruleY([0])
                    ]
                });

                return plot;
            }

            static appendTableOneYear(table) {
                const p = document.getElementById('section-table');
                p.appendChild(table);
            }

            static appendPlotOneYear(plot) {
                const p = document.getElementById('section-plot');
                p.appendChild(plot);
            }
        }

        const app = new BudgetApp();
        const view = BudgetView;

        async function testFetch() {
            document.getElementById('inputURL').value = './receipttest.csv';
            await onClickFetch();
            app.execCSVtoDataSource();
        }

        function main() {
        }

        // test
        (() => {
            main(); // params
            if (true === testProcedure) {
                testFetch();
            }
        })();

    </script>
</body>

</html>